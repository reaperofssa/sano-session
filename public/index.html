<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sano Pairing</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">Sano Pairing</h1>
        <div class="space-y-4">
            <div>
                <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input
                    type="text"
                    id="phoneNumber"
                    placeholder="1234567890"
                    class="mt-1 w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    oninput="this.value = this.value.replace(/\\D/g, '')"
                >
            </div>
            <button
                id="pairButton"
                class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                onclick="startPairing()"
            >
                Get Pairing Code
            </button>
            <div id="pairingCode" class="hidden text-center text-lg font-semibold text-green-600"></div>
            <div id="statusMessage" class="hidden text-center text-sm text-blue-600"></div>
            <div id="errorMessage" class="hidden text-center text-sm text-red-600"></div>
            <div id="credsContainer" class="hidden mt-4">
                <label class="block text-sm font-medium text-gray-700">Session ID</label>
                <textarea
                    id="base64Creds"
                    class="mt-1 w-full p-2 border rounded-md h-32 resize-none"
                    readonly
                ></textarea>
                <button
                    id="copyButton"
                    class="mt-2 w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700"
                    onclick="copyCreds()"
                >
                    Copy Session ID
                </button>
            </div>
        </div>
    </div>

    <script>
        let pollingInterval = null;

        async function startPairing() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const pairButton = document.getElementById('pairButton');
            const pairingCodeDiv = document.getElementById('pairingCode');
            const statusMessageDiv = document.getElementById('statusMessage');
            const errorMessageDiv = document.getElementById('errorMessage');
            const credsContainer = document.getElementById('credsContainer');

            // Reset UI
            pairingCodeDiv.classList.add('hidden');
            statusMessageDiv.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            credsContainer.classList.add('hidden');
            pairButton.disabled = true;

            // Clear any existing polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // Validate only numbers (10–15 digits)
            if (!/^\d{10,15}$/.test(phoneNumber)) {
                errorMessageDiv.textContent = 'Invalid phone number. Only digits allowed (10–15 digits)';
                errorMessageDiv.classList.remove('hidden');
                pairButton.disabled = false;
                return;
            }

            try {
                const response = await fetch('/pair', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number: phoneNumber })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    pairingCodeDiv.textContent = `Pairing Code: ${data.pairingCode}`;
                    pairingCodeDiv.classList.remove('hidden');
                    statusMessageDiv.textContent = 'Enter the code in WhatsApp to complete pairing...';
                    statusMessageDiv.classList.remove('hidden');
                    startPolling(phoneNumber);
                } else {
                    errorMessageDiv.textContent = data.error || 'Failed to get pairing code';
                    errorMessageDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorMessageDiv.textContent = 'Error connecting to server';
                errorMessageDiv.classList.remove('hidden');
            } finally {
                pairButton.disabled = false;
            }
        }

        async function startPolling(phoneNumber) {
            const credsContainer = document.getElementById('credsContainer');
            const base64Creds = document.getElementById('base64Creds');
            const statusMessageDiv = document.getElementById('statusMessage');
            const errorMessageDiv = document.getElementById('errorMessage');
            
            let pollCount = 0;
            const maxPolls = 60; // 5 minutes (5 seconds * 60)

            pollingInterval = setInterval(async () => {
                pollCount++;
                
                // Stop polling after 5 minutes
                if (pollCount > maxPolls) {
                    clearInterval(pollingInterval);
                    errorMessageDiv.textContent = 'Pairing timeout. Please try again.';
                    errorMessageDiv.classList.remove('hidden');
                    statusMessageDiv.classList.add('hidden');
                    return;
                }

                try {
                    // First check status
                    const statusResponse = await fetch(`/status/${phoneNumber}`);
                    const statusData = await statusResponse.json();

                    if (statusResponse.ok && statusData.success) {
                        if (statusData.status === 'completed') {
                            // Pairing completed, get session
                            clearInterval(pollingInterval);
                            statusMessageDiv.textContent = 'Pairing completed! Getting session...';
                            
                            try {
                                const sessionResponse = await fetch(`/session/${phoneNumber}`);
                                const sessionData = await sessionResponse.json();
                                
                                if (sessionResponse.ok && sessionData.success) {
                                    base64Creds.value = sessionData.sessionId;
                                    credsContainer.classList.remove('hidden');
                                    statusMessageDiv.textContent = 'Session ready! Session has also been sent to your WhatsApp.';
                                } else {
                                    errorMessageDiv.textContent = sessionData.error || 'Failed to get session';
                                    errorMessageDiv.classList.remove('hidden');
                                    statusMessageDiv.classList.add('hidden');
                                }
                            } catch (error) {
                                errorMessageDiv.textContent = 'Error getting session';
                                errorMessageDiv.classList.remove('hidden');
                                statusMessageDiv.classList.add('hidden');
                            }
                        } else if (statusData.status === 'pending') {
                            // Still waiting for pairing
                            statusMessageDiv.textContent = `Waiting for pairing... (${Math.floor(pollCount * 5 / 60)}:${String(pollCount * 5 % 60).padStart(2, '0')})`;
                        }
                    } else if (statusResponse.status === 404) {
                        // Session not found, might have expired
                        clearInterval(pollingInterval);
                        errorMessageDiv.textContent = 'Pairing session expired. Please try again.';
                        errorMessageDiv.classList.remove('hidden');
                        statusMessageDiv.classList.add('hidden');
                    }
                } catch (error) {
                    // Don't stop polling on network errors, just continue
                    console.error('Polling error:', error);
                }
            }, 5000); // Poll every 5 seconds
        }

        function copyCreds() {
            const base64Creds = document.getElementById('base64Creds');
            base64Creds.select();
            base64Creds.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    // Fallback for modern browsers
                    navigator.clipboard.writeText(base64Creds.value).then(() => {
                        showCopySuccess();
                    }).catch(() => {
                        alert('Please manually copy the session ID');
                    });
                }
            } catch (err) {
                // Modern clipboard API fallback
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(base64Creds.value).then(() => {
                        showCopySuccess();
                    }).catch(() => {
                        alert('Please manually copy the session ID');
                    });
                } else {
                    alert('Please manually copy the session ID');
                }
            }
        }

        function showCopySuccess() {
            const copyButton = document.getElementById('copyButton');
            const originalText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            copyButton.className = copyButton.className.replace('bg-green-600 hover:bg-green-700', 'bg-blue-600 hover:bg-blue-700');
            
            setTimeout(() => {
                copyButton.textContent = originalText;
                copyButton.className = copyButton.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-green-600 hover:bg-green-700');
            }, 2000);
        }

        // Clean up polling if user leaves page
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
